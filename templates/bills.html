{% extends "base.html" %}

{% block title %}Bills - Homie{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            <i class="fas fa-receipt mr-3 text-red-600"></i>Bills Manager
        </h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">
            Track all your monthly bills and due dates.
        </p>
    </div>

    <!-- Monthly Summary -->
    <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-lg p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold">Monthly Total</h2>
                <p class="text-red-100">All your bills combined</p>
            </div>
            <div class="text-right">
                <p class="text-4xl font-bold">£{{ "%.2f"|format(monthly_total or 0) }}</p>
                <p class="text-red-100">{{ bills|length }} bill{{ 's' if bills|length != 1 else '' }}</p>
            </div>
        </div>
    </div>

    <!-- Add Bill Form -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-8">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                Add New Bill
            </h3>
        </div>
        <div class="p-6">
            <form method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="bill_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Bill Name *
                    </label>
                    <input type="text" name="bill_name" id="bill_name" required
                           class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                           placeholder="e.g., Electricity, Gas, Internet">
                </div>
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Amount (£) *
                    </label>
                    <input type="number" name="amount" id="amount" step="0.01" min="0" required
                           class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                           placeholder="0.00">
                </div>
                <div>
                    <label for="due_day" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Due Day of Month *
                    </label>
                    <select name="due_day" id="due_day" required
                            class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Select day</option>
                        {% for day in range(1, 32) %}
                        <option value="{{ day }}">{{ day }}{{ 'st' if day == 1 or day == 21 or day == 31 else ('nd' if day == 2 or day == 22 else ('rd' if day == 3 or day == 23 else 'th')) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="md:col-span-3 flex justify-end">
                    <button type="submit"
                            class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Bill
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bills List -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <button onclick="document.getElementById('bills-section').classList.toggle('hidden')"
                    class="flex items-center justify-between w-full text-left">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                    Your Bills
                </h3>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                        Total: £{{ "%.2f"|format(monthly_total or 0) }}
                    </span>
                    <i class="fas fa-chevron-down text-gray-400"></i>
                </div>
            </button>
        </div>
        <div id="bills-section" class="divide-y divide-gray-200 dark:divide-gray-700">
            {% if bills %}
                {% for bill in bills %}
                <div class="item-row p-6 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="flex-shrink-0 h-12 w-12 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center">
                                <i class="fas fa-receipt text-red-600 dark:text-red-400"></i>
                            </div>
                            <div class="flex-grow">
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">
                                    {{ bill.bill_name }}
                                </h4>
                                <div class="flex items-center space-x-4 mt-1">
                                    <p class="text-xl font-bold text-red-600 dark:text-red-400">
                                        £{{ "%.2f"|format(bill.amount) }}
                                    </p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        Due: {{ bill.due_day }}{{ 'st' if bill.due_day == 1 or bill.due_day == 21 or bill.due_day == 31 else ('nd' if bill.due_day == 2 or bill.due_day == 22 else ('rd' if bill.due_day == 3 or bill.due_day == 23 else 'th')) }} of each month
                                    </p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        Added by {{ bill.added_by_username|title_case }}
                                    </p>
                                    {% if bill.days_until_due is not none %}
                                        {% if bill.days_until_due == 0 %}
                                        <p class="text-sm font-medium text-red-600 dark:text-red-300">
                                            <i class="fas fa-exclamation-circle mr-1"></i>Due today!
                                        </p>
                                        {% elif bill.days_until_due <= 3 %}
                                        <p class="text-sm font-medium text-yellow-600 dark:text-yellow-300">
                                            <i class="fas fa-clock mr-1"></i>Due in {{ bill.days_until_due }} day{{ 's' if bill.days_until_due != 1 else '' }}
                                        </p>
                                        {% elif bill.days_until_due > 0 %}
                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                            Due in {{ bill.days_until_due }} days
                                        </p>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <!-- Actions Dropdown for all devices -->
                            <div class="relative action-dropdown">
                                <button onclick="toggleActionMenu('bill-menu-{{ bill.id }}')"
                                        class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 focus:outline-none rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="bill-menu-{{ bill.id }}" class="action-menu hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-20 border border-gray-200 dark:border-gray-600">
                                    <button onclick="editBill({{ bill.id }}, '{{ bill.bill_name }}', {{ bill.amount }}, {{ bill.due_day }})"
                                            class="block w-full text-left px-4 py-2 text-sm text-blue-600 dark:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-md transition-colors">
                                        <i class="fas fa-edit mr-2"></i>Edit
                                    </button>
                                    <button onclick="deleteItem({{ bill.id }}, 'bill', this)"
                                            class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-b-md transition-colors border-t border-gray-200 dark:border-gray-600">
                                        <i class="fas fa-trash mr-2"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="p-12 text-center">
                <i class="fas fa-receipt text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                    No bills tracked yet
                </h3>
                <p class="text-gray-500 dark:text-gray-400">
                    Add your first bill using the form above.
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Upcoming Bills Calendar -->
    {% if bills %}
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg mt-8">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                This Month's Due Dates
            </h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-7 gap-2">
                {% for day in range(1, 32) %}
                    {% set day_bills = bills|selectattr('due_day', 'equalto', day)|list %}
                    <div class="min-h-16 p-2 border border-gray-200 dark:border-gray-600 rounded {{ 'bg-red-50 dark:bg-red-900/20 border-red-300 dark:border-red-700' if day_bills else '' }}">
                        <div class="text-sm font-medium text-gray-900 dark:text-white mb-1">
                            {{ day }}
                        </div>
                        {% if day_bills %}
                        <div class="space-y-1">
                            {% for bill in day_bills %}
                            <div class="text-xs px-1 py-0.5 bg-red-200 dark:bg-red-800 text-red-800 dark:text-red-200 rounded">
                                {{ bill.bill_name[:6] }}{{ '...' if bill.bill_name|length > 6 else '' }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Edit Bill Modal -->
<div id="editBillModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Edit Bill</h3>
            <form id="editBillForm" method="POST" action="/edit_bill">
                <input type="hidden" id="editBillId" name="bill_id">
                <div class="space-y-4">
                    <div>
                        <label for="editBillName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Bill Name *
                        </label>
                        <input type="text" id="editBillName" name="bill_name" required
                               class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label for="editAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Amount (£) *
                        </label>
                        <input type="number" id="editAmount" name="amount" step="0.01" min="0" required
                               class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label for="editDueDay" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Due Day of Month *
                        </label>
                        <select id="editDueDay" name="due_day" required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            {% for day in range(1, 32) %}
                            <option value="{{ day }}">{{ day }}{{ 'st' if day == 1 or day == 21 or day == 31 else ('nd' if day == 2 or day == 22 else ('rd' if day == 3 or day == 23 else 'th')) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditModal()"
                            class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        Update Bill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editBill(billId, billName, amount, dueDay) {
    document.getElementById('editBillId').value = billId;
    document.getElementById('editBillName').value = billName;
    document.getElementById('editAmount').value = amount;
    document.getElementById('editDueDay').value = dueDay;
    document.getElementById('editBillModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editBillModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('editBillModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});
</script>
{% endblock %}